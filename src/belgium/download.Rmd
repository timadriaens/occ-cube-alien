---
title: "Download GBIF occurrences"
author:
- Damiano Oldoni
- Peter Desmet
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
---

This document describes how to retrieve occurrences for assessing the emerging status of alien species in Belgium.

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Load libraries:

```{r load_libraries}
library(tidyverse)      # To do data science
library(lubridate)      # To work with dates
library(here)           # To find files
library(rgbif)          # To use GBIF services
library(trias)          # To use functions developed for TrIAS
```

# Define download query parameters

## Define taxa

As the list of alien species from the unified checklist is too long for a query to the GBIF API, we don't define any taxa.

## Define countries

Only query occurrences from Belgium.

```{r define_countries}
countries <- c("BE")
```

## Define basis of record

Everything except `FOSSIL SPECIMEN` and `LIVING SPECIMEN`:

```{r define_basis_of_record}
basis_of_record <- c(
  "OBSERVATION", 
  "HUMAN_OBSERVATION",
  "MATERIAL_SAMPLE", 
  "LITERATURE", 
  "PRESERVED_SPECIMEN", 
  "UNKNOWN", 
  "MACHINE_OBSERVATION"
)
```

## Define year

We will limit to occurrence with valid year.

```{r define_year}
year_begin <- 1000
year_end <- year(Sys.Date())
```

## Define geographic coordinates

We need occurrences with valid geographic coordinates:

```{r define_hasCoordinate}
hasCoordinate <- TRUE
```

# Download GBIF occurrences

## Trigger download

**Note**: GBIF credentials are required in the next step, i.e. `gbif_user`, `gbif_pwd`, `gbif_email` should be defined in your `.Renviron` file. 

Trigger download:

```{r trigger_gbif_download}
# Important: query arguments need to be pasts as strings of format "key = value"
gbif_download_key <- occ_download(
  paste0("country = ", paste(countries, collapse = ",")),
  paste0("basisOfRecord = ", paste(basis_of_record, collapse = ",")),
  paste0("year >= ", year_begin),
  paste0("year <= ", year_end),
  paste0("hasCoordinate = ", hasCoordinate),
  user = rstudioapi::askForPassword("GBIF username"),
  pwd = rstudioapi::askForPassword("GBIF password"),
  email = rstudioapi::askForPassword("Email address for notification")
)
```

# Check status of download

```{r}
metadata <- occ_download_meta(key = gbif_download_key)
metadata$key
metadata$status
```

Write download to list of downloads and check pending downloads:

```{r}
update_download_list(
  file = here("data", "processed", "gbif_downloads.tsv"), 
  download_to_add = gbif_download_key, 
  input_checklist = ""
)
```
